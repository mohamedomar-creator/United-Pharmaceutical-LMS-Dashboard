<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>United Pharmaceuticals - LMS Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0066cc 0%, #004080 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #0066cc, #004080);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
            border-left: 5px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .stat-card .icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .stat-card.completed { border-left-color: #28a745; }
        .stat-card.completed .icon { color: #28a745; }
        
        .stat-card.progress { border-left-color: #ffc107; }
        .stat-card.progress .icon { color: #ffc107; }
        
        .stat-card.pending { border-left-color: #dc3545; }
        .stat-card.pending .icon { color: #dc3545; }
        
        .stat-card.average { border-left-color: #17a2b8; }
        .stat-card.average .icon { color: #17a2b8; }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .stat-card .label {
            color: #666;
            font-size: 1.1em;
            font-weight: 600;
        }

        .filters-section {
            padding: 30px;
            background: white;
            border-bottom: 2px solid #f0f0f0;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .search-input, .filter-select, .date-input {
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .search-input:focus, .filter-select:focus, .date-input:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .multi-select {
            position: relative;
        }

        .multi-select-trigger {
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-trigger:hover {
            border-color: #0066cc;
        }

        .multi-select-trigger::after {
            content: "▼";
            font-size: 12px;
            color: #666;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #0066cc;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .multi-select-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .multi-select-option:last-child {
            border-bottom: none;
        }

        .multi-select-option:hover {
            background: #f8f9fa;
        }

        .multi-select-option input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .multi-select-option label {
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }

        .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
            min-height: 20px;
        }

        .selected-item {
            background: #0066cc;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-item {
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .remove-item:hover {
            color: #ff6b6b;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .chart-container {
            padding: 30px;
            background: white;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-wrapper {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            height: 400px;
        }

        .chart-wrapper canvas {
            max-height: 320px !important;
        }

        .chart-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .status-chart-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            height: 450px;
        }

        .status-chart-container canvas {
            max-height: 350px !important;
        }

        .table-container {
            padding: 30px;
            background: white;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        th {
            background: linear-gradient(45deg, #0066cc, #004080);
            color: white;
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 15px 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }

        tr:hover td {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-progress {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-pending {
            background-color: #f8d7da;
            color: #721c24;
        }

        .course-mandatory {
            background-color: #f8d7da;
            color: #721c24;
        }

        .course-optional {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 18px;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-container {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 United Pharmacies</h1>
            <p>Learning Management System Dashboard - Course Completion Analytics</p>
        </div>

        <div class="stats-container">
            <div class="stat-card completed">
                <span class="icon">✅</span>
                <div class="number" id="completedCount">0</div>
                <div class="label">Completed</div>
            </div>
            <div class="stat-card progress">
                <span class="icon">⏳</span>
                <div class="number" id="progressCount">0</div>
                <div class="label">In Progress</div>
            </div>
            <div class="stat-card pending">
                <span class="icon">⏸️</span>
                <div class="number" id="pendingCount">0</div>
                <div class="label">Pending</div>
            </div>
            <div class="stat-card average">
                <span class="icon">📊</span>
                <div class="number" id="averageRate">0%</div>
                <div class="label">Average Rate</div>
            </div>
        </div>

        <div class="filters-section">
            <h3 style="margin-bottom: 20px; color: #333;">🔍 Filters & Search</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Search Pharmacists</label>
                    <input type="text" class="search-input" id="pharmacistSearch" placeholder="Search by name...">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Completed">Completed</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Course Type</label>
                    <select class="filter-select" id="courseTypeFilter">
                        <option value="">All Types</option>
                        <option value="Mandatory">Mandatory</option>
                        <option value="Optional">Optional</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">From Date</label>
                    <input type="date" class="date-input" id="dateFrom">
                </div>

                <div class="filter-group">
                    <label class="filter-label">To Date</label>
                    <input type="date" class="date-input" id="dateTo">
                </div>

                <div class="filter-group">
                    <label class="filter-label">Cities</label>
                    <div class="multi-select" id="cityMultiSelect">
                        <div class="multi-select-trigger">Select Cities...</div>
                        <div class="multi-select-dropdown" id="cityDropdown"></div>
                        <div class="selected-items" id="selectedCities"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Supervisors</label>
                    <div class="multi-select" id="supervisorMultiSelect">
                        <div class="multi-select-trigger">Select Supervisors...</div>
                        <div class="multi-select-dropdown" id="supervisorDropdown"></div>
                        <div class="selected-items" id="selectedSupervisors"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Districts</label>
                    <div class="multi-select" id="districtMultiSelect">
                        <div class="multi-select-trigger">Select Districts...</div>
                        <div class="multi-select-dropdown" id="districtDropdown"></div>
                        <div class="selected-items" id="selectedDistricts"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Courses</label>
                    <div class="multi-select" id="courseMultiSelect">
                        <div class="multi-select-trigger">Select Courses...</div>
                        <div class="multi-select-dropdown" id="courseDropdown"></div>
                        <div class="selected-items" id="selectedCourses"></div>
                    </div>
                </div>

                <div class="filter-group" style="align-self: end;">
                    <button class="btn btn-secondary" id="clearFilters">Clear All Filters</button>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="charts-grid">
                <div class="chart-wrapper">
                    <h3 class="chart-title">🏙️ Cities Performance</h3>
                    <canvas id="citiesChart"></canvas>
                </div>

                <div class="chart-wrapper">
                    <h3 class="chart-title">👥 Supervisors Performance</h3>
                    <canvas id="supervisorsChart"></canvas>
                </div>

                <div class="chart-wrapper">
                    <h3 class="chart-title">📚 Courses Performance</h3>
                    <canvas id="coursesChart"></canvas>
                </div>

                <div class="chart-wrapper">
                    <h3 class="chart-title">📖 Mandatory vs Optional</h3>
                    <canvas id="courseTypesChart"></canvas>
                </div>

                <div class="chart-wrapper">
                    <h3 class="chart-title">📍 Districts Performance</h3>
                    <canvas id="districtsChart"></canvas>
                </div>

                <div class="chart-wrapper">
                    <h3 class="chart-title">📈 Performance Trend</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="status-chart-container">
                <h3 class="chart-title">📊 Status Distribution</h3>
                <div style="max-width: 350px; margin: 0 auto; height: 300px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3 style="color: #333; margin: 0;">📋 Pharmacists Data</h3>
                <button class="btn btn-primary" id="toggleTableBtn">Hide Table</button>
            </div>

            <div id="loadingMessage" class="loading">
                Loading data from Google Sheets... ⏳
            </div>

            <div id="errorMessage" class="error" style="display: none;">
                Error loading data. Please check the Google Sheet and try again.
            </div>

            <div id="tableSection">
                <table id="dataTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Pharmacist</th>
                            <th>City</th>
                            <th>District</th>
                            <th>Supervisor</th>
                            <th>Course</th>
                            <th>Type</th>
                            <th>Completion</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets configuration
        const SHEET_ID = '1GLqdVQbTqKs4y7IMYtQITYgOCMZGtYOLiH84pFCeBDQ';
        const SHEET_NAME = 'Sheet1'; // Change if your sheet has a different name
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

        // Global variables
        let pharmacistsData = [];
        let filteredData = [];
        let selectedCities = [];
        let selectedSupervisors = [];
        let selectedDistricts = [];
        let selectedCourses = [];
        
        let charts = {
            cities: null,
            supervisors: null,
            courses: null,
            courseTypes: null,
            districts: null,
            performance: null,
            status: null
        };

        // Load data from Google Sheets
        async function loadDataFromSheet() {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                
                // Remove the callback wrapper from Google's response
                const jsonText = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonText);
                
                // Parse the data
                const rows = data.table.rows;
                const headers = data.table.cols.map(col => col.label || col.id);
                
                pharmacistsData = rows.map(row => {
                    const rowData = {};
                    headers.forEach((header, index) => {
                        const cell = row.c[index];
                        rowData[header] = cell ? cell.v : '';
                    });
                    
                    // Map the column names to match our expected format
                    return {
                        name: rowData['Pharmacist Name'] || rowData['Name'] || '',
                        city: rowData['City'] || '',
                        district: rowData['District'] || '',
                        supervisor: rowData['Supervisor'] || '',
                        course: rowData['Course'] || rowData['Course Name'] || '',
                        courseType: rowData['Course Type'] || rowData['Type'] || '',
                        completion: parseInt(rowData['Completion Rate'] || rowData['Completion'] || 0),
                        status: rowData['Status'] || '',
                        dateCompleted: rowData['Date Completed'] || rowData['Date'] || ''
                    };
                }).filter(item => item.name); // Filter out empty rows

                filteredData = [...pharmacistsData];
                
                // Hide loading message and show data
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                
                // Initialize dashboard
                setupMultiSelectFilters();
                setupEventListeners();
                updateDashboard();
                
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        // Initialize dashboard
        function initDashboard() {
            loadDataFromSheet();
        }

        // Setup multi-select filters
        function setupMultiSelectFilters() {
            if (pharmacistsData.length === 0) return;
            
            const cities = [...new Set(pharmacistsData.map(p => p.city).filter(city => city))];
            const supervisors = [...new Set(pharmacistsData.map(p => p.supervisor).filter(supervisor => supervisor))];
            const districts = [...new Set(pharmacistsData.map(p => p.district).filter(district => district))];
            const courses = [...new Set(pharmacistsData.map(p => p.course).filter(course => course))];

            setupMultiSelect('cityMultiSelect', cities, selectedCities);
            setupMultiSelect('supervisorMultiSelect', supervisors, selectedSupervisors);
            setupMultiSelect('districtMultiSelect', districts, selectedDistricts);
            setupMultiSelect('courseMultiSelect', courses, selectedCourses);
        }

        // Setup individual multi-select
        function setupMultiSelect(containerId, options, selectedArray) {
            const container = document.getElementById(containerId);
            const trigger = container.querySelector('.multi-select-trigger');
            const dropdown = container.querySelector('.multi-select-dropdown');
            const selectedContainer = container.querySelector('.selected-items');

            // Create options
            dropdown.innerHTML = '';
            options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'multi-select-option';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${containerId}_${index}`;
                checkbox.value = option;

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = option;

                div.appendChild(checkbox);
                div.appendChild(label);
                dropdown.appendChild(div);

                // Add event listener
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        if (!selectedArray.includes(option)) {
                            selectedArray.push(option);
                        }
                    } else {
                        const index = selectedArray.indexOf(option);
                        if (index > -1) {
                            selectedArray.splice(index, 1);
                        }
                    }
                    updateSelectedItems(selectedContainer, selectedArray, containerId);
                    applyFilters();
                });
            });

            // Toggle dropdown
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = dropdown.style.display === 'block';
                
                // Close all dropdowns
                document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                    d.style.display = 'none';
                });
                
                // Toggle current dropdown
                dropdown.style.display = isVisible ? 'none' : 'block';
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });

            // Prevent closing when clicking inside dropdown
            dropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // Update selected items display
        function updateSelectedItems(container, selectedArray, containerId) {
            container.innerHTML = '';
            
            selectedArray.forEach(item => {
                const span = document.createElement('span');
                span.className = 'selected-item';
                span.innerHTML = `${item} <span class="remove-item" data-value="${item}">×</span>`;
                
                const removeBtn = span.querySelector('.remove-item');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeSelectedItem(item, selectedArray, containerId);
                });
                
                container.appendChild(span);
            });

            // Update trigger text
            const trigger = container.parentElement.querySelector('.multi-select-trigger');
            if (selectedArray.length === 0) {
                const type = containerId.replace('MultiSelect', '');
                trigger.textContent = `Select ${type.charAt(0).toUpperCase() + type.slice(1)}...`;
            } else {
                trigger.textContent = `${selectedArray.length} selected`;
            }
        }

        // Remove selected item
        function removeSelectedItem(value, selectedArray, containerId) {
            const index = selectedArray.indexOf(value);
            if (index > -1) {
                selectedArray.splice(index, 1);
                
                // Uncheck corresponding checkbox
                const checkbox = document.querySelector(`#${containerId} input[value="${value}"]`);
                if (checkbox) checkbox.checked = false;
                
                const container = document.querySelector(`#${containerId} .selected-items`);
                updateSelectedItems(container, selectedArray, containerId);
                applyFilters();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('pharmacistSearch').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('courseTypeFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFrom').addEventListener('change', applyFilters);
            document.getElementById('dateTo').addEventListener('change', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearAllFilters);
            document.getElementById('toggleTableBtn').addEventListener('click', toggleTable);
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('pharmacistSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const courseTypeFilter = document.getElementById('courseTypeFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredData = pharmacistsData.filter(pharmacist => {
                const matchesSearch = pharmacist.name.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || pharmacist.status === statusFilter;
                const matchesCourseType = !courseTypeFilter || pharmacist.courseType === courseTypeFilter;
                const matchesCity = selectedCities.length === 0 || selectedCities.includes(pharmacist.city);
                const matchesSupervisor = selectedSupervisors.length === 0 || selectedSupervisors.includes(pharmacist.supervisor);
                const matchesDistrict = selectedDistricts.length === 0 || selectedDistricts.includes(pharmacist.district);
                const matchesCourse = selectedCourses.length === 0 || selectedCourses.includes(pharmacist.course);
                
                let matchesDate = true;
                if (dateFrom || dateTo) {
                    const pharmacistDate = new Date(pharmacist.dateCompleted);
                    if (dateFrom && pharmacistDate < new Date(dateFrom)) matchesDate = false;
                    if (dateTo && pharmacistDate > new Date(dateTo)) matchesDate = false;
                }

                return matchesSearch && matchesStatus && matchesCourseType && 
                       matchesCity && matchesSupervisor && matchesDistrict && 
                       matchesCourse && matchesDate;
            });

            updateDashboard();
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('pharmacistSearch').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('courseTypeFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            selectedCities.length = 0;
            selectedSupervisors.length = 0;
            selectedDistricts.length = 0;
            selectedCourses.length = 0;
            
            // Reset all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // Reset selected items displays
            document.querySelectorAll('.selected-items').forEach(container => {
                container.innerHTML = '';
            });
            
            // Reset trigger texts
            document.getElementById('cityMultiSelect').querySelector('.multi-select-trigger').textContent = 'Select Cities...';
            document.getElementById('supervisorMultiSelect').querySelector('.multi-select-trigger').textContent = 'Select Supervisors...';
            document.getElementById('districtMultiSelect').querySelector('.multi-select-trigger').textContent = 'Select Districts...';
            document.getElementById('courseMultiSelect').querySelector('.multi-select-trigger').textContent = 'Select Courses...';
            
            filteredData = [...pharmacistsData];
            updateDashboard();
        }

        // Toggle table visibility
        function toggleTable() {
            const tableSection = document.getElementById('tableSection');
            const toggleBtn = document.getElementById('toggleTableBtn');
            
            if (tableSection.style.display === 'none') {
                tableSection.style.display = 'block';
                toggleBtn.textContent = 'Hide Table';
                toggleBtn.className = 'btn btn-primary';
            } else {
                tableSection.style.display = 'none';
                toggleBtn.textContent = 'Show Table';
                toggleBtn.className = 'btn btn-secondary';
            }
        }

        // Update entire dashboard
        function updateDashboard() {
            updateStats();
            updateTable();
            updateCharts();
        }

        // Update statistics cards with better handling
        function updateStats() {
            const completed = filteredData.filter(p => p.status === 'Completed').length;
            const progress = filteredData.filter(p => p.status === 'In Progress').length;
            const pending = filteredData.filter(p => p.status === 'Pending').length;
            const averageCompletion = filteredData.length > 0 ? 
                Math.round(filteredData.reduce((sum, p) => sum + p.completion, 0) / filteredData.length) : 0;
            
            // Reset to 0 first if values are dramatically different to avoid confusion
            const currentCompleted = parseInt(document.getElementById('completedCount').textContent) || 0;
            const currentProgress = parseInt(document.getElementById('progressCount').textContent) || 0;
            const currentPending = parseInt(document.getElementById('pendingCount').textContent) || 0;
            
            // If the change is too dramatic (more than 50% difference), reset first
            if (Math.abs(completed - currentCompleted) > Math.max(completed, currentCompleted) * 0.5) {
                document.getElementById('completedCount').textContent = '0';
            }
            if (Math.abs(progress - currentProgress) > Math.max(progress, currentProgress) * 0.5) {
                document.getElementById('progressCount').textContent = '0';
            }
            if (Math.abs(pending - currentPending) > Math.max(pending, currentPending) * 0.5) {
                document.getElementById('pendingCount').textContent = '0';
            }
            
            // Small delay to show the reset, then animate to new values
            setTimeout(() => {
                animateCounter('completedCount', completed);
                animateCounter('progressCount', progress);
                animateCounter('pendingCount', pending);
                document.getElementById('averageRate').textContent = averageCompletion + '%';
            }, 100);
        }

        // Animate counter with proper handling for decreasing values
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = parseInt(element.textContent) || 0;
            
            // If target is 0 or values are the same, set directly
            if (targetValue === 0 || startValue === targetValue) {
                element.textContent = targetValue;
                return;
            }
            
            // For large differences, animate more smoothly
            const difference = Math.abs(targetValue - startValue);
            const duration = Math.min(1000, Math.max(300, difference * 20)); // Dynamic duration
            const steps = Math.min(50, Math.max(10, difference)); // Dynamic steps
            const stepValue = (targetValue - startValue) / steps;
            const stepDuration = duration / steps;
            
            let currentValue = startValue;
            let stepCount = 0;

            const timer = setInterval(() => {
                stepCount++;
                if (stepCount >= steps) {
                    element.textContent = targetValue; // Ensure exact final value
                    clearInterval(timer);
                } else {
                    currentValue += stepValue;
                    element.textContent = Math.round(currentValue);
                }
            }, stepDuration);
        }

        // Update table
        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            filteredData.forEach(pharmacist => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${pharmacist.name}</strong></td>
                    <td>${pharmacist.city}</td>
                    <td>${pharmacist.district}</td>
                    <td>${pharmacist.supervisor}</td>
                    <td><strong>${pharmacist.course}</strong></td>
                    <td>
                        <span class="status-badge ${pharmacist.courseType === 'Mandatory' ? 'course-mandatory' : 'course-optional'}">
                            ${pharmacist.courseType}
                        </span>
                    </td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pharmacist.completion}%"></div>
                        </div>
                        <small><strong>${pharmacist.completion}%</strong></small>
                    </td>
                    <td>
                        <span class="status-badge status-${pharmacist.status === 'Completed' ? 'completed' : pharmacist.status === 'In Progress' ? 'progress' : 'pending'}">
                            ${pharmacist.status}
                        </span>
                    </td>
                    <td>${pharmacist.dateCompleted}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Update all charts
        function updateCharts() {
            createCitiesChart();
            createSupervisorsChart();
            createCoursesChart();
            createCourseTypesChart();
            createDistrictsChart();
            createPerformanceChart();
            createStatusChart();
        }

        // Create cities chart
        function createCitiesChart() {
            const ctx = document.getElementById('citiesChart').getContext('2d');
            
            if (charts.cities) {
                charts.cities.destroy();
            }

            const cityStats = {};
            const citiesToShow = selectedCities.length > 0 ? selectedCities : [...new Set(filteredData.map(p => p.city).filter(city => city))];
            
            citiesToShow.forEach(city => {
                const cityData = filteredData.filter(p => p.city === city);
                if (cityData.length > 0) {
                    cityStats[city] = {
                        average: Math.round(cityData.reduce((sum, p) => sum + p.completion, 0) / cityData.length),
                        count: cityData.length
                    };
                }
            });

            const labels = Object.keys(cityStats);
            const averages = labels.map(city => cityStats[city].average);

            charts.cities = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Completion Rate (%)',
                        data: averages,
                        backgroundColor: 'rgba(0, 102, 204, 0.8)',
                        borderColor: 'rgba(0, 102, 204, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Completion Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        // Create supervisors chart
        function createSupervisorsChart() {
            const ctx = document.getElementById('supervisorsChart').getContext('2d');
            
            if (charts.supervisors) {
                charts.supervisors.destroy();
            }

            const supervisorStats = {};
            const supervisorsToShow = selectedSupervisors.length > 0 ? selectedSupervisors : [...new Set(filteredData.map(p => p.supervisor).filter(supervisor => supervisor))];
            
            supervisorsToShow.forEach(supervisor => {
                const supervisorData = filteredData.filter(p => p.supervisor === supervisor);
                if (supervisorData.length > 0) {
                    supervisorStats[supervisor] = {
                        average: Math.round(supervisorData.reduce((sum, p) => sum + p.completion, 0) / supervisorData.length),
                        count: supervisorData.length
                    };
                }
            });

            const labels = Object.keys(supervisorStats).map(name => name.replace('Dr. ', ''));
            const averages = Object.values(supervisorStats).map(stat => stat.average);

            charts.supervisors = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Completion Rate (%)',
                        data: averages,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Completion Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        // Create courses chart
        function createCoursesChart() {
            const ctx = document.getElementById('coursesChart').getContext('2d');
            
            if (charts.courses) {
                charts.courses.destroy();
            }

            const courseStats = {};
            const coursesToShow = selectedCourses.length > 0 ? selectedCourses : [...new Set(filteredData.map(p => p.course).filter(course => course))];
            
            coursesToShow.forEach(course => {
                const courseData = filteredData.filter(p => p.course === course);
                if (courseData.length > 0) {
                    courseStats[course] = {
                        average: Math.round(courseData.reduce((sum, p) => sum + p.completion, 0) / courseData.length),
                        count: courseData.length
                    };
                }
            });

            const labels = Object.keys(courseStats);
            const averages = labels.map(course => courseStats[course].average);

            charts.courses = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Completion Rate (%)',
                        data: averages,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Completion Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        // Create course types chart
        function createCourseTypesChart() {
            const ctx = document.getElementById('courseTypesChart').getContext('2d');
            
            if (charts.courseTypes) {
                charts.courseTypes.destroy();
            }

            const mandatoryData = filteredData.filter(p => p.courseType === 'Mandatory');
            const optionalData = filteredData.filter(p => p.courseType === 'Optional');

            const mandatoryAvg = mandatoryData.length > 0 ? 
                Math.round(mandatoryData.reduce((sum, p) => sum + p.completion, 0) / mandatoryData.length) : 0;
            const optionalAvg = optionalData.length > 0 ? 
                Math.round(optionalData.reduce((sum, p) => sum + p.completion, 0) / optionalData.length) : 0;

            charts.courseTypes = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mandatory Courses', 'Optional Courses'],
                    datasets: [{
                        data: [mandatoryAvg, optionalAvg],
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(40, 167, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(220, 53, 69, 1)',
                            'rgba(40, 167, 69, 1)'
                        ],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Create districts chart
        function createDistrictsChart() {
            const ctx = document.getElementById('districtsChart').getContext('2d');
            
            if (charts.districts) {
                charts.districts.destroy();
            }

            const districtStats = {};
            const districtsToShow = selectedDistricts.length > 0 ? selectedDistricts : [...new Set(filteredData.map(p => p.district).filter(district => district))];
            
            districtsToShow.forEach(district => {
                const districtData = filteredData.filter(p => p.district === district);
                if (districtData.length > 0) {
                    districtStats[district] = Math.round(districtData.reduce((sum, p) => sum + p.completion, 0) / districtData.length);
                }
            });

            const labels = Object.keys(districtStats);
            const averages = Object.values(districtStats);

            charts.districts = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Completion Rate (%)',
                        data: averages,
                        backgroundColor: 'rgba(0, 102, 204, 0.2)',
                        borderColor: 'rgba(0, 102, 204, 1)',
                        pointBackgroundColor: 'rgba(0, 102, 204, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(0, 102, 204, 1)',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Create performance trend chart
        function createPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (charts.performance) {
                charts.performance.destroy();
            }

            // Generate trend data based on actual completion dates
            const dateStats = {};
            
            filteredData.forEach(pharmacist => {
                const date = pharmacist.dateCompleted;
                if (date) {
                    if (!dateStats[date]) {
                        dateStats[date] = {
                            total: 0,
                            count: 0
                        };
                    }
                    dateStats[date].total += pharmacist.completion;
                    dateStats[date].count += 1;
                }
            });

            // Sort dates and calculate averages
            const sortedDates = Object.keys(dateStats).sort();
            const dates = sortedDates.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const completionRates = sortedDates.map(date => Math.round(dateStats[date].total / dateStats[date].count));

            // If no data, show sample trend
            if (dates.length === 0) {
                for (let i = 30; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                    const avgCompletion = filteredData.length > 0 
                        ? Math.round(filteredData.reduce((sum, p) => sum + p.completion, 0) / filteredData.length)
                        : 0;
                    
                    const variance = Math.random() * 20 - 10;
                    completionRates.push(Math.max(0, Math.min(100, avgCompletion + variance)));
                }
            }

            charts.performance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Daily Completion Rate (%)',
                        data: completionRates,
                        borderColor: 'rgba(0, 102, 204, 1)',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Completion Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        // Create status distribution chart
        function createStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (charts.status) {
                charts.status.destroy();
            }

            const completed = filteredData.filter(p => p.status === 'Completed').length;
            const progress = filteredData.filter(p => p.status === 'In Progress').length;
            const pending = filteredData.filter(p => p.status === 'Pending').length;

            charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Pending'],
                    datasets: [{
                        data: [completed, progress, pending],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>

