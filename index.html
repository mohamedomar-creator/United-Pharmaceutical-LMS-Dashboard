<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>United Pharmaceuticals - LMS Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #0066cc 0%, #004080 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); overflow: hidden; }
        .header { background: linear-gradient(45deg, #0066cc, #004080); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.8em; margin-bottom: 10px; font-weight: 700; }
        .header p { font-size: 1.3em; opacity: 0.9; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 30px; background: #f8f9fa; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); text-align: center; transition: all 0.3s ease; border-left: 5px solid transparent; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); }
        .stat-card .icon { font-size: 3em; margin-bottom: 15px; display: block; }
        .stat-card.completed { border-left-color: #28a745; }
        .stat-card.completed .icon { color: #28a745; }
        .stat-card.progress { border-left-color: #ffc107; }
        .stat-card.progress .icon { color: #ffc107; }
        .stat-card.pending { border-left-color: #dc3545; }
        .stat-card.pending .icon { color: #dc3545; }
        .stat-card.average { border-left-color: #17a2b8; }
        .stat-card.average .icon { color: #17a2b8; }
        .stat-card .number { font-size: 2.5em; font-weight: bold; color: #333; margin-bottom: 10px; }
        .stat-card .label { color: #666; font-size: 1.1em; font-weight: 600; }
        .filters-section { padding: 30px; background: white; border-bottom: 2px solid #f0f0f0; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .filter-group { display: flex; flex-direction: column; gap: 8px; position: relative; }
        .filter-label { font-weight: 600; color: #333; font-size: 14px; }
        .search-input, .filter-select, .date-input { padding: 12px 16px; border: 2px solid #ddd; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; font-family: inherit; }
        .search-input:focus, .filter-select:focus, .date-input:focus { outline: none; border-color: #0066cc; box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1); }
        .multi-select { position: relative; }
        .multi-select-trigger { padding: 12px 16px; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer; font-size: 14px; transition: all 0.3s ease; user-select: none; display: flex; justify-content: space-between; align-items: center; }
        .multi-select-trigger:hover { border-color: #0066cc; }
        .multi-select-trigger::after { content: "‚ñº"; font-size: 12px; color: #666; }
        .multi-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #0066cc; border-radius: 10px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .multi-select-option { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; border-bottom: 1px solid #f0f0f0; }
        .multi-select-option:hover { background: #f8f9fa; }
        .multi-select-option input[type="checkbox"] { margin: 0; cursor: pointer; }
        .multi-select-option label { cursor: pointer; font-size: 14px; flex: 1; }
        .selected-items { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; min-height: 20px; }
        .selected-item { background: #0066cc; color: white; padding: 4px 8px; border-radius: 15px; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .remove-item { cursor: pointer; font-weight: bold; font-size: 14px; }
        .remove-item:hover { color: #ff6b6b; }
        .autocomplete-items { border: 1px solid #d4d4d4; border-top: none; max-height: 200px; overflow-y: auto; position: absolute; background: white; z-index: 99; width: 100%; border-radius: 0 0 10px 10px; margin-top: -2px; }
        .autocomplete-items div { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-items div:hover { background-color: #e9e9e9; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; }
        .btn-primary { background: #0066cc; color: white; }
        .btn-primary:hover { background: #0052a3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .chart-container { padding: 30px; background: white; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-wrapper { background: #f8f9fa; border-radius: 15px; padding: 20px; height: 400px; }
        .chart-title { font-size: 1.4em; font-weight: 600; margin-bottom: 20px; color: #333; text-align: center; }
        .status-chart-container { background: #f8f9fa; border-radius: 15px; padding: 20px; height: 450px; }
        .table-container { padding: 30px; background: white; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        th { background: linear-gradient(45deg, #0066cc, #004080); color: white; padding: 15px 12px; text-align: center; font-weight: 600; font-size: 14px; }
        td { padding: 15px 12px; text-align: center; border-bottom: 1px solid #eee; }
        tr:hover td { background-color: #f8f9fa; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-progress { background-color: #fff3cd; color: #856404; }
        .status-pending { background-color: #f8d7da; color: #721c24; }
        .course-mandatory { background-color: #f8d7da; color: #721c24; }
        .course-optional { background-color: #d1ecf1; color: #0c5460; }
        .progress-bar { width: 100%; height: 8px; background-color: #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s ease; }
        .loading { text-align: center; padding: 50px; color: #666; font-size: 18px; }
        .error { text-align: center; padding: 50px; color: #dc3545; font-size: 18px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <img src="https://raw.githubusercontent.com/mohamedomar-creator/United-Pharmaceutical-LMS-Dashboard/main/united-logo.png.png" alt="United Pharmaceuticals Logo" style="height: 60px;">
                <h1>United Pharmaceuticals</h1>
            </div>
            <p>LMS Dashboard - Course Completion Analytics</p>
        </div>
        <div class="stats-container">
            <div class="stat-card completed"><span class="icon">‚úÖ</span><div class="number" id="completedCount">0</div><div class="label">Completed</div></div>
            <div class="stat-card progress"><span class="icon">‚è≥</span><div class="number" id="progressCount">0</div><div class="label">In Progress</div></div>
            <div class="stat-card pending"><span class="icon">‚è∏Ô∏è</span><div class="number" id="pendingCount">0</div><div class="label">Pending</div></div>
                            <div class="stat-card average"><span class="icon">üìä</span><div class="number" id="averageRate">0%</div><div class="label">Completion Rate</div></div>
        </div>
        <div class="filters-section">
            <h3 style="margin-bottom:20px;color:#333;">üîç Filters & Search</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Search by Name</label>
                    <input type="text" class="search-input" id="pharmacistSearch" placeholder="Pharmacist name..." autocomplete="off">
                    <div id="autocomplete-list" class="autocomplete-items"></div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Search by Email</label>
                    <input type="text" class="search-input" id="emailSearch" placeholder="Email address..." autocomplete="off">
                </div>
                <div class="filter-group"><label class="filter-label">Status</label><select class="filter-select" id="statusFilter"><option value="">All</option><option value="Completed">Completed</option><option value="In Progress">In Progress</option><option value="Pending">Pending</option></select></div>
                <div class="filter-group"><label class="filter-label">Type</label><select class="filter-select" id="courseTypeFilter"><option value="">All</option><option value="Mandatory">Mandatory</option><option value="Optional">Optional</option></select></div>
                <div class="filter-group"><label class="filter-label">From Date</label><input type="date" class="date-input" id="dateFrom"></div>
                <div class="filter-group"><label class="filter-label">To Date</label><input type="date" class="date-input" id="dateTo"></div>
                <div class="filter-group"><label class="filter-label">Cities</label><div class="multi-select" id="cityMultiSelect"><div class="multi-select-trigger">Select...</div><div class="multi-select-dropdown" id="cityDropdown"></div><div class="selected-items" id="selectedCities"></div></div></div>
                <div class="filter-group"><label class="filter-label">Supervisors</label><div class="multi-select" id="supervisorMultiSelect"><div class="multi-select-trigger">Select...</div><div class="multi-select-dropdown" id="supervisorDropdown"></div><div class="selected-items" id="selectedSupervisors"></div></div></div>
                <div class="filter-group"><label class="filter-label">Districts</label><div class="multi-select" id="districtMultiSelect"><div class="multi-select-trigger">Select...</div><div class="multi-select-dropdown" id="districtDropdown"></div><div class="selected-items" id="selectedDistricts"></div></div></div>
                <div class="filter-group"><label class="filter-label">Courses</label><div class="multi-select" id="courseMultiSelect"><div class="multi-select-trigger">Select...</div><div class="multi-select-dropdown" id="courseDropdown"></div><div class="selected-items" id="selectedCourses"></div></div></div>
                <div class="filter-group" style="align-self:end;"><button class="btn btn-secondary" id="clearFilters">Clear All</button></div>
            </div>
        </div>
        <div class="chart-container">
            <div class="charts-grid">
                <div class="chart-wrapper"><h3 class="chart-title">üèôÔ∏è Cities Performance</h3><canvas id="citiesChart"></canvas></div>
                <div class="chart-wrapper"><h3 class="chart-title">üë• Supervisors Performance</h3><canvas id="supervisorsChart"></canvas></div>
                <div class="chart-wrapper"><h3 class="chart-title">üìö Courses Performance</h3><canvas id="coursesChart"></canvas></div>
                <div class="chart-wrapper"><h3 class="chart-title">üìñ Mandatory vs Optional</h3><canvas id="courseTypesChart"></canvas></div>
                <div class="chart-wrapper"><h3 class="chart-title">üë§ Districts Performance</h3><canvas id="districtsChart"></canvas></div>
                <div class="chart-wrapper"><h3 class="chart-title">üìà Performance Trend</h3><canvas id="performanceChart"></canvas></div>
            </div>
            <div class="status-chart-container"><h3 class="chart-title">üìä Status Distribution</h3><div style="max-width:350px;margin:0 auto;height:350px;"><canvas id="statusChart"></canvas></div></div>
        </div>
        <div class="table-container">
            <div class="table-header"><h3 style="color:#333;margin:0;">üìã Pharmacists Data</h3><button class="btn btn-primary" id="toggleTableBtn">Hide Table</button></div>
            <div id="loadingMessage" class="loading">Loading data from Google Sheets...</div>
            <div id="errorMessage" class="error" style="display:none;">Error loading data. Please check your connection.</div>
            <div id="tableSection"><table id="dataTable" style="display:none;"><thead><tr><th>Name</th><th>Email</th><th>City</th><th>District</th><th>Supervisor</th><th>Course</th><th>Type</th><th>Completion</th><th>Status</th><th>Date</th></tr></thead><tbody id="tableBody"></tbody></table></div>
        </div>
    </div>
    <script>
const SHEET_ID='1GLqdVQbTqKs4y7IMYtQITYgOCMZGtYOLiH84pFCeBDQ';
const SHEET_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet1`;
let data=[],filtered=[],selC=[],selS=[],selD=[],selCo=[],charts={};

async function load(){
    try{
        const r=await fetch(SHEET_URL);
        const t=await r.text();
        const j=JSON.parse(t.substring(47).slice(0,-2));
        const rows=j.table.rows;
        const h=j.table.cols.map(c=>c.label||c.id);
        data=rows.map(row=>{
            const rd={};
            h.forEach((hd,i)=>{
                const cell=row.c[i];
                rd[hd]=cell?cell.v:'';
            });
            return{
                name:rd['Pharmacist Name']||rd['Name']||'',
                email:rd['Email']||'',
                city:rd['City']||'',
                district:rd['District']||'',
                supervisor:rd['Supervisor']||'',
                course:rd['Course']||rd['Course Name']||'',
                courseType:rd['Course Type']||rd['Type']||'',
                completion:parseInt(rd['Completion Rate']||rd['Completion']||0),
                status:rd['Status']||'',
                dateCompleted:rd['Date Completed']||rd['Date']||''
            };
        }).filter(i=>i.name);
        filtered=[...data];
        document.getElementById('loadingMessage').style.display='none';
        document.getElementById('dataTable').style.display='table';
        setupFilters();
        setupEvents();
        update();
    }catch(e){
        console.error(e);
        document.getElementById('loadingMessage').style.display='none';
        document.getElementById('errorMessage').style.display='block';
    }
}

function setupFilters(){
    if(!data.length)return;
    const cities=[...new Set(data.map(p=>p.city).filter(c=>c))];
    const supervisors=[...new Set(data.map(p=>p.supervisor).filter(s=>s))];
    const districts=[...new Set(data.map(p=>p.district).filter(d=>d))];
    const courses=[...new Set(data.map(p=>p.course).filter(c=>c))];
    setupMS('cityMultiSelect',cities,selC);
    setupMS('supervisorMultiSelect',supervisors,selS);
    setupMS('districtMultiSelect',districts,selD);
    setupMS('courseMultiSelect',courses,selCo);
}

function setupMS(id,opts,arr){
    const cont=document.getElementById(id);
    const trig=cont.querySelector('.multi-select-trigger');
    const drop=cont.querySelector('.multi-select-dropdown');
    const selCont=cont.querySelector('.selected-items');
    drop.innerHTML='';
    opts.forEach((opt,i)=>{
        const div=document.createElement('div');
        div.className='multi-select-option';
        const cb=document.createElement('input');
        cb.type='checkbox';
        cb.id=`${id}_${i}`;
        cb.value=opt;
        const lbl=document.createElement('label');
        lbl.htmlFor=cb.id;
        lbl.textContent=opt;
        div.appendChild(cb);
        div.appendChild(lbl);
        drop.appendChild(div);
        cb.addEventListener('change',()=>{
            if(cb.checked){
                if(!arr.includes(opt))arr.push(opt);
            }else{
                const idx=arr.indexOf(opt);
                if(idx>-1)arr.splice(idx,1);
            }
            updateSel(selCont,arr,id);
            filter();
        });
    });
    trig.addEventListener('click',e=>{
        e.stopPropagation();
        const vis=drop.style.display==='block';
        document.querySelectorAll('.multi-select-dropdown').forEach(d=>d.style.display='none');
        drop.style.display=vis?'none':'block';
    });
    document.addEventListener('click',e=>{
        if(!cont.contains(e.target))drop.style.display='none';
    });
}

function updateSel(cont,arr,id){
    cont.innerHTML='';
    arr.forEach(item=>{
        const sp=document.createElement('span');
        sp.className='selected-item';
        sp.innerHTML=`${item} <span class="remove-item">√ó</span>`;
        sp.querySelector('.remove-item').addEventListener('click',e=>{
            e.stopPropagation();
            const idx=arr.indexOf(item);
            if(idx>-1){
                arr.splice(idx,1);
                const cb=document.querySelector(`#${id} input[value="${item}"]`);
                if(cb)cb.checked=false;
                updateSel(cont,arr,id);
                filter();
            }
        });
        cont.appendChild(sp);
    });
    const trig=cont.parentElement.querySelector('.multi-select-trigger');
    trig.textContent=arr.length===0?'Select...':`${arr.length} selected`;
}

function setupEvents(){
    document.getElementById('statusFilter').addEventListener('change',filter);
    document.getElementById('courseTypeFilter').addEventListener('change',filter);
    document.getElementById('dateFrom').addEventListener('change',filter);
    document.getElementById('dateTo').addEventListener('change',filter);
    document.getElementById('clearFilters').addEventListener('click',clear);
    document.getElementById('toggleTableBtn').addEventListener('click',toggle);
    
    const si=document.getElementById('pharmacistSearch');
    const ei=document.getElementById('emailSearch');
    const lc=document.getElementById('autocomplete-list');
    
    si.addEventListener('input',function(){
        const v=this.value.toLowerCase().trim();
        lc.innerHTML='';
        if(!v)return;
        const m=data.filter(p=>p.name.toLowerCase().includes(v));
        m.slice(0,10).forEach(p=>{
            const it=document.createElement('div');
            it.innerHTML=`<strong>${p.name}</strong>${p.email?' - '+p.email:''} - ${p.city}`;
            it.addEventListener('click',()=>{
                si.value=p.name;
                lc.innerHTML='';
                filter();
            });
            lc.appendChild(it);
        });
    });
    
    ei.addEventListener('input',filter);
    
    document.addEventListener('click',e=>{
        if(e.target!==si)lc.innerHTML='';
    });
}

function filter(){
    const st=document.getElementById('pharmacistSearch').value.toLowerCase();
    const et=document.getElementById('emailSearch').value.toLowerCase();
    const sf=document.getElementById('statusFilter').value;
    const cf=document.getElementById('courseTypeFilter').value;
    const df=document.getElementById('dateFrom').value;
    const dt=document.getElementById('dateTo').value;
    filtered=data.filter(p=>{
        const ms=!st||p.name.toLowerCase().includes(st);
        const me=!et||(p.email&&p.email.toLowerCase().includes(et));
        const mst=!sf||p.status===sf;
        const mct=!cf||p.courseType===cf;
        const mci=selC.length===0||selC.includes(p.city);
        const msu=selS.length===0||selS.includes(p.supervisor);
        const mdi=selD.length===0||selD.includes(p.district);
        const mco=selCo.length===0||selCo.includes(p.course);
        let md=true;
        if(df||dt){
            if(p.dateCompleted){
                const pd=parseDate(p.dateCompleted);
                if(pd){
                    if(df){const dfDate=new Date(df);if(pd<dfDate)md=false;}
                    if(dt){const dtDate=new Date(dt);if(pd>dtDate)md=false;}
                }else{md=false;}
            }else{md=false;}
        }
        return ms&&me&&mst&&mct&&mci&&msu&&mdi&&mco&&md;
    });
    update();
}

function parseDate(dateStr){
    if(!dateStr)return null;
    let d=new Date(dateStr);
    if(!isNaN(d.getTime()))return d;
    const parts=dateStr.split(/[-/]/);
    if(parts.length===3){
        if(parts[0].length===4){d=new Date(parts[0],parts[1]-1,parts[2]);}
        else if(parts[2].length===4){d=new Date(parts[2],parts[1]-1,parts[0]);}
        else{d=new Date(parts[2],parts[0]-1,parts[1]);}
        if(!isNaN(d.getTime()))return d;
    }
    return null;
}

function clear(){
    document.getElementById('pharmacistSearch').value='';
    document.getElementById('emailSearch').value='';
    document.getElementById('statusFilter').value='';
    document.getElementById('courseTypeFilter').value='';
    document.getElementById('dateFrom').value='';
    document.getElementById('dateTo').value='';
    selC.length=0;
    selS.length=0;
    selD.length=0;
    selCo.length=0;
    document.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
    document.querySelectorAll('.selected-items').forEach(c=>c.innerHTML='');
    document.querySelectorAll('.multi-select-trigger').forEach(t=>t.textContent='Select...');
    filtered=[...data];
    update();
}

function toggle(){
    const ts=document.getElementById('tableSection');
    const tb=document.getElementById('toggleTableBtn');
    if(ts.style.display==='none'){
        ts.style.display='block';
        tb.textContent='Hide Table';
        tb.className='btn btn-primary';
    }else{
        ts.style.display='none';
        tb.textContent='Show Table';
        tb.className='btn btn-secondary';
    }
}

function update(){
    updateStats();
    updateTable();
    updateCharts();
}

function updateStats(){
    const co=filtered.filter(p=>p.status==='Completed').length;
    const pr=filtered.filter(p=>p.status==='In Progress').length;
    const pe=filtered.filter(p=>p.status==='Pending').length;
    const total=co+pr+pe;
    const av=total>0?Math.round((co/total)*100):0;
    document.getElementById('completedCount').textContent=co;
    document.getElementById('progressCount').textContent=pr;
    document.getElementById('pendingCount').textContent=pe;
    document.getElementById('averageRate').textContent=av+'%';
}

function updateTable(){
    const tb=document.getElementById('tableBody');
    tb.innerHTML='';
    filtered.forEach(p=>{
        const r=document.createElement('tr');
        r.innerHTML=`<td><strong>${p.name}</strong></td><td>${p.email||'-'}</td><td>${p.city}</td><td>${p.district}</td><td>${p.supervisor}</td><td><strong>${p.course}</strong></td><td><span class="status-badge ${p.courseType==='Mandatory'?'course-mandatory':'course-optional'}">${p.courseType}</span></td><td><div class="progress-bar"><div class="progress-fill" style="width:${p.completion}%"></div></div><small><strong>${p.completion}%</strong></small></td><td><span class="status-badge status-${p.status==='Completed'?'completed':p.status==='In Progress'?'progress':'pending'}">${p.status}</span></td><td>${p.dateCompleted}</td>`;
        tb.appendChild(r);
    });
}

function updateCharts(){
    createChart('citiesChart','bar',selC.length>0?selC:[...new Set(filtered.map(p=>p.city).filter(c=>c))],'city');
    createChart('supervisorsChart','bar',selS.length>0?selS:[...new Set(filtered.map(p=>p.supervisor).filter(s=>s))],'supervisor');
    createChart('coursesChart','bar',selCo.length>0?selCo:[...new Set(filtered.map(p=>p.course).filter(c=>c))],'course');
    createTypeChart();
    createChart('districtsChart','bar',selD.length>0?selD:[...new Set(filtered.map(p=>p.district).filter(d=>d))],'district',true);
    createTrendChart();
    createStatusChart();
}

function createChart(id,type,items,field,horiz=false){
    const ctx=document.getElementById(id).getContext('2d');
    if(charts[id])charts[id].destroy();
    const stats={};
    items.forEach(item=>{
        const d=filtered.filter(p=>p[field]===item);
        if(d.length>0)stats[item]=Math.round(d.reduce((s,p)=>s+p.completion,0)/d.length);
    });
    const labels=Object.keys(stats);
    const values=Object.values(stats);
    charts[id]=new Chart(ctx,{
        type,
        data:{
            labels,
            datasets:[{
                label:'Completion %',
                data:values,
                backgroundColor:'rgba(0,102,204,0.8)',
                borderColor:'rgba(0,102,204,1)',
                borderWidth:2
            }]
        },
        options:{
            indexAxis:horiz?'y':'x',
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{display:false}},
            scales:{
                [horiz?'x':'y']:{beginAtZero:true,max:100}
            }
        }
    });
}

function createTypeChart(){
    const ctx=document.getElementById('courseTypesChart').getContext('2d');
    if(charts.courseTypes)charts.courseTypes.destroy();
    const md=filtered.filter(p=>p.courseType==='Mandatory');
    const od=filtered.filter(p=>p.courseType==='Optional');
    const ma=md.length>0?Math.round(md.reduce((s,p)=>s+p.completion,0)/md.length):0;
    const oa=od.length>0?Math.round(od.reduce((s,p)=>s+p.completion,0)/od.length):0;
    charts.courseTypes=new Chart(ctx,{
        type:'doughnut',
        data:{
            labels:['Mandatory','Optional'],
            datasets:[{
                data:[ma,oa],
                backgroundColor:['rgba(220,53,69,0.8)','rgba(40,167,69,0.8)'],
                borderWidth:3
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{position:'bottom'}}
        }
    });
}

function createTrendChart(){
    const ctx=document.getElementById('performanceChart').getContext('2d');
    if(charts.performance)charts.performance.destroy();
    const ds={};
    filtered.forEach(p=>{
        if(p.dateCompleted){
            const pd=parseDate(p.dateCompleted);
            if(pd){
                const dateKey=pd.toISOString().split('T')[0];
                if(!ds[dateKey])ds[dateKey]={t:0,c:0};
                ds[dateKey].t+=p.completion;
                ds[dateKey].c++;
            }
        }
    });
    const sd=Object.keys(ds).sort();
    const dates=sd.map(d=>{const dt=new Date(d);return dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});});
    const rates=sd.map(d=>Math.round(ds[d].t/ds[d].c));
    if(dates.length===0){
        for(let i=30;i>=0;i--){
            const d=new Date();
            d.setDate(d.getDate()-i);
            dates.push(d.toLocaleDateString('en-US',{month:'short',day:'numeric'}));
            rates.push(Math.round(50+Math.random()*30));
        }
    }
    charts.performance=new Chart(ctx,{
        type:'line',
        data:{
            labels:dates,
            datasets:[{
                label:'Daily %',
                data:rates,
                borderColor:'rgba(0,102,204,1)',
                backgroundColor:'rgba(0,102,204,0.1)',
                tension:0.4,
                fill:true
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{display:false}},
            scales:{y:{beginAtZero:true,max:100}}
        }
    });
}

function createStatusChart(){
    const ctx=document.getElementById('statusChart').getContext('2d');
    if(charts.status)charts.status.destroy();
    const co=filtered.filter(p=>p.status==='Completed').length;
    const pr=filtered.filter(p=>p.status==='In Progress').length;
    const pe=filtered.filter(p=>p.status==='Pending').length;
    charts.status=new Chart(ctx,{
        type:'doughnut',
        data:{
            labels:['Completed','In Progress','Pending'],
            datasets:[{
                data:[co,pr,pe],
                backgroundColor:['rgba(40,167,69,0.8)','rgba(255,193,7,0.8)','rgba(220,53,69,0.8)'],
                borderWidth:3
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:true,
            plugins:{legend:{position:'bottom'}}
        }
    });
}

document.addEventListener('DOMContentLoaded',load);
    </script>
</body>
</html>
